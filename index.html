<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bake your cake</title>

  <!-- A-Frame + physics -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-physics-system@v3.3.0/dist/aframe-physics-system.min.js"></script>

  <style>
    body, html { margin:0; padding:0; height:100%; width:100%; font-family:sans-serif; background:#000; }

    /* Start screen & cake choices */
    #startScreen, #cakeChoices {
      position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center;
      background-size:cover; background-position:center; z-index:100;
    }
    #startScreen { background-image: url('https://cdn.pixabay.com/photo/2015/01/14/19/20/bake-599521_1280.jpg'); }
    #cakeChoices { background-image: url('https://cdn.pixabay.com/photo/2015/01/14/19/20/bake-599521_1280.jpg'); display:none; }
    #startScreen::before, #cakeChoices::before { content:""; position:absolute; inset:0; background:rgba(0,0,0,0.5); z-index:-1; }

    .cake-tab { padding:18px 22px; border-radius:10px; color:white; font-size:18px; cursor:pointer; text-align:center; width:200px; font-weight:700; margin:10px; }
    #strawberryTab{background:#FF69B4;}
    #blueberryTab{background:#1E90FF;}
    #cherryTab{background:#c71585;}

    /* UI overlay (recipe, loading, quit) */
    #recipePanel {
      position:fixed; top:18%; left:3%; z-index:9999; min-width:220px; padding:18px; border-radius:10px;
      font-size:16px; color:#fff; display:none; pointer-events:auto; box-shadow:0 6px 20px rgba(0,0,0,0.6);
      background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.4));
    }
    #recipePanel h2 { margin:0 0 8px; font-size:20px; text-align:center; }
    #recipePanel ul { list-style:none; padding:0; margin:0; max-height:60vh; overflow:auto; }
    #recipePanel li { margin:6px 0; font-weight:700; }
    #recipePanel li.collected { color: #9be6a1; text-decoration:line-through; }

    #loadingBarContainer {
      position: fixed; bottom:22px; left:50%; transform:translateX(-50%); width:60%; height:26px;
      background:#ddd; border-radius:20px; overflow:hidden; display:none; z-index:9999;
    }
    #loadingBar { width:0%; height:100%; background:#ff69b4; transition:width 5s linear; }

    #quitButton {
      position:fixed; right:18px; top:18px; z-index:9999; display:none;
      padding:10px 16px; border-radius:8px; background:#ff5678; color:#fff; border:none; font-weight:700; cursor:pointer;
    }

    /* Small helper text at bottom-left for debug */
    #debugHint { position:fixed; left:12px; bottom:12px; z-index:9998; color:#fff; font-size:13px; opacity:0.8; }
  </style>
</head>
<body>
  <!-- Start UI -->
  <div id="startScreen">
    <h1 style="color:white;font-size:36px;margin-bottom:12px">Bake your cake</h1>
    <button onclick="startGame()" style="padding:12px 20px;font-size:18px;border-radius:8px;cursor:pointer">Start</button>
  </div>

  <div id="cakeChoices">
    <div style="display:flex;flex-direction:column;align-items:center;">
      <div class="cake-tab" id="strawberryTab" onclick="chooseCake('strawberry')">Strawberry Cake</div>
      <div class="cake-tab" id="blueberryTab" onclick="chooseCake('blueberry')">Blueberry Cake</div>
      <div class="cake-tab" id="cherryTab" onclick="chooseCake('cherry')">Cherry Cake</div>
      <button onclick="backToStart()" style="margin-top:12px;padding:8px 14px;border-radius:8px;cursor:pointer">Back</button>
    </div>
  </div>

  <!-- Recipe + loading + quit -->
  <div id="recipePanel"></div>
  <div id="loadingBarContainer"><div id="loadingBar"></div></div>
  <button id="quitButton" onclick="quitGame()">Quit</button>
  <div id="debugHint">Open Console (F12) for model logs</div>

  <!-- A-Frame Scene -->
  <a-scene id="scene" physics="gravity: -9.8;" style="display:none;">
    <!-- Player rig back to normal human height -->
    <a-entity id="rig" position="0 1.6 7" movement-controls="speed:6">
      <a-camera id="firstPersonCam" look-controls camera="active:true">
        <a-cursor rayOrigin="mouse" fuse="false" material="color:black; shader:flat"></a-cursor>
      </a-camera>
    </a-entity>

    <!-- Lighting -->
    <a-entity light="type:ambient; intensity:0.8"></a-entity>
    <a-entity light="type:directional; intensity:1.0" position="10 20 20"></a-entity>

    <!-- World models -->
    <a-entity id="e_floor" gltf-model="floor.glb" static-body></a-entity>
    <a-entity id="e_fridge" gltf-model="fridge.glb" static-body></a-entity>
    <a-entity id="e_countertopdecor" gltf-model="countertopdecor.glb" static-body></a-entity>
    <a-entity id="e_mixingbowl" gltf-model="mixingbowl.glb" static-body></a-entity>
    <a-entity id="e_stove" gltf-model="stove.glb" static-body></a-entity>
    <a-entity id="e_backwall" gltf-model="backwall.glb" static-body></a-entity>
    <a-entity id="e_frontwall" gltf-model="frontwall.glb" static-body></a-entity>
    <a-entity id="e_leftwall" gltf-model="leftwall.glb" static-body></a-entity>
    <a-entity id="e_rightwall" gltf-model="rightwall.glb" static-body></a-entity>
    <a-entity id="e_windowdecor" gltf-model="windowdecor.glb" static-body></a-entity>
    <a-entity id="e_light" gltf-model="light.glb" static-body></a-entity>
    <a-entity id="e_wallclock" gltf-model="wallclock.glb" static-body></a-entity>
    <a-entity id="e_walldecor" gltf-model="walldecor.glb" static-body></a-entity>
    <a-entity id="e_walllines" gltf-model="walllines.glb" static-body></a-entity>
    <a-entity id="e_rollingpin" gltf-model="rollingpin.glb" static-body></a-entity>
    <a-entity id="e_smallplate" gltf-model="smallplate.glb" static-body></a-entity>
    <a-entity id="e_stool" gltf-model="stool.glb" static-body></a-entity>
    <a-entity id="e_pan" gltf-model="pan.glb" static-body></a-entity>
    <a-entity id="e_plate" gltf-model="plate.glb" static-body></a-entity>
    <a-entity id="e_mug1" gltf-model="mug1.glb" static-body></a-entity>
    <a-entity id="e_eggcarton" gltf-model="eggcarton.glb" static-body></a-entity>
    <a-entity id="e_chefhat" gltf-model="chefhat.glb" static-body></a-entity>
    <a-entity id="e_exhaustfan" gltf-model="exhaustfan.glb" static-body></a-entity>
    <a-entity id="e_cuttingboard" gltf-model="cuttingboard.glb" static-body></a-entity>

    <!-- Collectables -->
    <a-entity id="flour" gltf-model="flour.glb" class="collectable" collectable data-name="flour" static-body></a-entity>
    <a-entity id="sugar" gltf-model="sugar.glb" class="collectable" collectable data-name="sugar" static-body></a-entity>
    <a-entity id="butter" gltf-model="butter.glb" class="collectable" collectable data-name="butter" static-body></a-entity>
    <a-entity id="milk" gltf-model="milk.glb" class="collectable" collectable data-name="milk" static-body></a-entity>
    <a-entity id="chocolate" gltf-model="chocolate.glb" class="collectable" collectable data-name="chocolate" static-body></a-entity>
    <a-entity id="strawberry" gltf-model="strawberry.glb" class="collectable" collectable data-name="strawberry" static-body></a-entity>
    <a-entity id="vanilla" gltf-model="vanilla.glb" class="collectable" collectable data-name="vanilla" static-body></a-entity>
    <a-entity id="whisk" gltf-model="whisk.glb" class="collectable" collectable data-name="whisk" static-body></a-entity>
    <a-entity id="eggcarton" gltf-model="eggcarton.glb" class="collectable" collectable data-name="eggcarton" static-body></a-entity>
  </a-scene>

  <script>
    let currentIngredients = [];
    let currentCake = "";
    const recipePanel = document.getElementById('recipePanel');
    const loadingBarContainer = document.getElementById('loadingBarContainer');
    const loadingBar = document.getElementById('loadingBar');

    function startGame(){
      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('cakeChoices').style.display = 'flex';
    }
    function backToStart(){
      document.getElementById('cakeChoices').style.display = 'none';
      document.getElementById('startScreen').style.display = 'flex';
    }

    function chooseCake(cakeName){
      currentCake = cakeName;
      document.getElementById('cakeChoices').style.display = 'none';
      document.getElementById('scene').style.display = 'block';
      recipePanel.style.display = 'block';
      recipePanel.className = cakeName;

      if (cakeName === 'blueberry') {
        currentIngredients = ["flour","sugar","butter","milk","vanilla","blueberry","strawberry","spatula","whisk","eggcarton"];
      } else if (cakeName === 'strawberry') {
        currentIngredients = ["flour","sugar","butter","milk","vanilla","chocolate","strawberry","spatula","whisk","eggcarton"];
      } else if (cakeName === 'cherry') {
        currentIngredients = ["flour","sugar","butter","milk","vanilla","cherries","spatula","whisk","eggcarton"];
      }

      recipePanel.innerHTML = `<h2>${cakeName.charAt(0).toUpperCase()+cakeName.slice(1)} Cake</h2>
        <ul>${currentIngredients.map(i => `<li id="recipe-${i.replace(/\s+/g,'-')}"><span class="check"></span> ${i}</li>`).join('')}</ul>`;
    }

    AFRAME.registerComponent('collectable',{
      init: function(){
        this.el.addEventListener('click', () => {
          const rawName = this.el.getAttribute('data-name');
          if (!rawName) return;
          const name = rawName;
          const found = currentIngredients.find(i => i.toLowerCase() === name.toLowerCase());
          if (found) {
            this.el.setAttribute('visible', false);
            const li = document.getElementById(`recipe-${found.replace(/\s+/g,'-')}`);
            if (li) {
              li.querySelector('.check').textContent = 'âœ…';
              li.classList.add('collected');
            }
            const allCollected = currentIngredients.every(i => {
              const li2 = document.getElementById(`recipe-${i.replace(/\s+/g,'-')}`);
              return li2 && li2.classList.contains('collected');
            });
            if (allCollected) showLoadingBar();
          }
        });
      }
    });

    function showLoadingBar(){
      loadingBarContainer.style.display = 'block';
      loadingBar.style.width = '0%';
      setTimeout(()=> loadingBar.style.width = '100%', 100);
      setTimeout(()=> {
        loadingBarContainer.style.display = 'none';
        document.getElementById('quitButton').style.display = 'block';
        let cakeModel = 'cake.glb';
        if (currentCake === 'strawberry') cakeModel = 'strawberrycake.glb';
        if (currentCake === 'blueberry') cakeModel = 'blueberrycake.glb';
        if (currentCake === 'cherry') cakeModel = 'cherrycake.glb';
        const cam = document.querySelector('#firstPersonCam');
        if (cam && cam.object3D) {
          const camObj = cam.object3D;
          const forward = new THREE.Vector3();
          camObj.getWorldDirection(forward);
          const spawnPos = new THREE.Vector3();
          camObj.getWorldPosition(spawnPos);
          spawnPos.add(forward.multiplyScalar(2.5));
          spawnPos.y = spawnPos.y - 1.5;
          const cakeEnt = document.createElement('a-entity');
          cakeEnt.setAttribute('gltf-model', cakeModel);
          cakeEnt.setAttribute('position', `${spawnPos.x} ${spawnPos.y} ${spawnPos.z}`);
          document.querySelector('a-scene').appendChild(cakeEnt);
        }
      }, 5200);
    }

    function quitGame(){
      document.getElementById('scene').style.display = 'none';
      recipePanel.style.display = 'none';
      document.getElementById('quitButton').style.display = 'none';
      document.getElementById('startScreen').style.display = 'flex';
      document.querySelectorAll("a-entity[gltf-model]").forEach(ent => {
        const modelAttr = ent.getAttribute('gltf-model') || '';
        if (typeof modelAttr === 'string' && modelAttr.toLowerCase().includes('cake')) {
          ent.remove();
        }
      });
      currentIngredients = [];
    }
  </script>
</body>
</html>
