<!-- Same <head> as before -->

<a-scene id="scene" physics="gravity:-9.8" style="display:none;">
  <!-- Player camera with collision -->
  <a-entity id="player" kinematic-body position="0 45 0">
    <a-entity id="cameraRig" camera look-controls wasd-controls="acceleration:150" position="0 0 0">
      <a-entity cursor="fuse:false; rayOrigin:mouse" 
                raycaster="objects:.click-target" 
                position="0 0 -1" 
                geometry="primitive:ring; radiusInner:0.01; radiusOuter:0.015" 
                material="color:black; shader:flat">
      </a-entity>
    </a-entity>
  </a-entity>

  <!-- Lights -->
  <a-entity light="type:ambient; intensity:0.5"></a-entity>
  <a-entity light="type:directional; intensity:0.8" position="0 2 1"></a-entity>

  <!-- Full kitchen objects with collision -->
  <a-entity id="backwall" gltf-model="backwall.glb" static-body></a-entity>
  <a-entity id="frontwall" gltf-model="frontwall.glb" static-body></a-entity>
  <a-entity id="rightwall" gltf-model="rightwall.glb" static-body></a-entity>
  <a-entity id="leftwall" gltf-model="leftwall.glb" static-body></a-entity>
  <a-entity id="floor" gltf-model="floor.glb" static-body></a-entity>
  <a-entity id="fridge" gltf-model="fridge.glb" static-body></a-entity>
  <a-entity id="roof" gltf-model="roof.glb" static-body></a-entity>
  <a-entity id="counterdecor" gltf-model="counterdecor.glb" static-body></a-entity>
  <a-entity id="counters" gltf-model="counters.glb" static-body></a-entity>
  <a-entity id="radio" gltf-model="radio.glb" static-body></a-entity>
  <a-entity id="light" gltf-model="light.glb" static-body></a-entity>
  <a-entity id="salt" gltf-model="salt.glb" static-body></a-entity>
  <a-entity id="eggcarton" gltf-model="eggcarton.glb" static-body></a-entity>
  <a-entity id="mixingbowl" gltf-model="mixingbowl.glb" static-body></a-entity>
  <a-entity id="cuttingboard" gltf-model="cuttingboard.glb" static-body></a-entity>
  <a-entity id="shelves" gltf-model="shelves.glb" static-body></a-entity>
  <a-entity id="knife" gltf-model="knife.glb" static-body></a-entity>
  <a-entity id="stool" gltf-model="stool.glb" static-body></a-entity>
  <a-entity id="stove" gltf-model="stove.glb" static-body></a-entity>

  <!-- Collectables with collision and "Press E to collect" -->
  <a-entity id="flour" gltf-model="flour.glb" class="collectable" static-body data-name="flour"></a-entity>
  <a-entity id="sugar" gltf-model="sugar.glb" class="collectable" static-body data-name="sugar"></a-entity>
  <a-entity id="butter" gltf-model="butter.glb" class="collectable" static-body data-name="butter"></a-entity>
  <a-entity id="milk" gltf-model="milk.glb" class="collectable" static-body data-name="milk"></a-entity>
  <a-entity id="vanilla" gltf-model="vanilla.glb" class="collectable" static-body data-name="vanilla"></a-entity>
  <a-entity id="blueberry" gltf-model="blueberry.glb" class="collectable" static-body data-name="blueberry"></a-entity>
  <a-entity id="strawberry" gltf-model="strawberry.glb" class="collectable" static-body data-name="strawberry"></a-entity>
  <a-entity id="chocolate" gltf-model="chocolate.glb" class="collectable" static-body data-name="chocolate"></a-entity>
  <a-entity id="spatula" gltf-model="spatula.glb" class="collectable" static-body data-name="spatula"></a-entity>
  <a-entity id="whisk" gltf-model="whisk.glb" class="collectable" static-body data-name="whisk"></a-entity>
  <a-entity id="banana" gltf-model="banana.glb" class="collectable" static-body data-name="banana"></a-entity>
  <a-entity id="cherries" gltf-model="cherries.glb" class="collectable" static-body data-name="cherries"></a-entity>
  <a-entity id="egg" gltf-model="egg.glb" class="collectable" static-body data-name="egg"></a-entity>

  <a-sound id="mainmusic" src="baking cooking jazz.mp3" autoplay="false" loop="true"></a-sound>
</a-scene>

<script>
let currentIngredients = [];

// Start game
function startGame(){
  document.getElementById('startScreen').style.display='none';
  document.getElementById('cakeChoices').style.display='flex';
  const music = document.querySelector('#mainmusic');
  if(music && music.components && music.components.sound && !music.components.sound.isPlaying){
    music.components.sound.playSound();
  }
}

// Choose cake
function chooseCake(cakeName){
  document.getElementById('cakeChoices').style.display='none';
  document.getElementById('scene').style.display='block';
  const recipePanel = document.getElementById('recipePanel');
  recipePanel.style.display='block';
  recipePanel.className = cakeName;
  if(cakeName==='blueberry'){
    currentIngredients = ["flour","sugar","butter","milk","vanilla","blueberry","strawberry","spatula","whisk","banana","cherries","egg"];
  } else if(cakeName==='chocolate'){
    currentIngredients = ["flour","sugar","butter","milk","vanilla","chocolate","strawberry","spatula","whisk","banana","cherries","egg"];
  } else if(cakeName==='cherry'){
    currentIngredients = ["flour","sugar","butter","milk","vanilla","cherry","spatula","whisk","banana","cherries","egg"];
  }
  recipePanel.innerHTML = `<h2>${cakeName.charAt(0).toUpperCase()+cakeName.slice(1)} Cake</h2>
    <ul>${currentIngredients.map(i=>`<li id="recipe-${i.replace(/\s+/g,'-')}"><span class="check"></span> ${i}</li>`).join('')}</ul>`;
}

// Add collision detection to collectables
AFRAME.registerComponent('collectable-trigger', {
  init: function () {
    this.playerInRange = false;
    const tip = document.getElementById('collect-tip');
    const el = this.el;
    this.tick = () => {
      const player = document.getElementById('player');
      if(!player) return;
      const playerPos = new THREE.Vector3();
      const objPos = new THREE.Vector3();
      player.object3D.getWorldPosition(playerPos);
      el.object3D.getWorldPosition(objPos);
      const distance = playerPos.distanceTo(objPos);
      if(distance < 2){
        if(!this.playerInRange){
          this.playerInRange = true;
          tip.style.display = 'block';
        }
      } else {
        if(this.playerInRange){
          this.playerInRange = false;
          tip.style.display = 'none';
        }
      }
    };
  }
});

// Attach trigger to all collectables
document.addEventListener('DOMContentLoaded', () => {
  const collectables = document.querySelectorAll('.collectable');
  collectables.forEach(c => {
    c.setAttribute('collectable-trigger','');
  });
});

// Press E to collect
document.addEventListener('keydown', function(e){
  if(e.key.toLowerCase() !== 'e') return;
  const tip = document.getElementById('collect-tip');
  const player = document.getElementById('player');
  const collectables = document.querySelectorAll('.collectable');
  collectables.forEach(c => {
    const playerPos = new THREE.Vector3();
    const objPos = new THREE.Vector3();
    player.object3D.getWorldPosition(playerPos);
    c.object3D.getWorldPosition(objPos);
    if(playerPos.distanceTo(objPos) < 2){
      const name = c.getAttribute('data-name');
      if(currentIngredients.includes(name)){
        c.setAttribute('visible','false');
        const li = document.getElementById(`recipe-${name.replace(/\s+/g,'-')}`);
        if(li){ li.querySelector('.check').textContent='âœ…'; li.classList.add('collected'); }
      }
    }
  });
  tip.style.display = 'none';
});
</script>
