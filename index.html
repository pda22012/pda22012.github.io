<!DOCTYPE html>
<html>
<head>
  <title>Bake your cake - FINAL FIX</title>
  <!-- A-Frame Core -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- A-Frame Physics System -->
  <script src="https://cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.3.0/dist/aframe-physics-system.min.js"></script>
  
  <style>
    body, html { margin:0; padding:0; height:100%; width:100%; font-family:sans-serif; overflow: hidden; }
    #startScreen, #cakeChoices { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background-size:cover; z-index:10; }
    #startScreen { background: url('https://cdn.pixabay.com/photo/2015/01/14/19/20/bake-599521_1280.jpg') no-repeat center center; }
    #startScreen::before, #cakeChoices::before { content:""; position:absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:-1; }
    #cakeChoices { background: url('https://cdn.pixabay.com/photo/2015/01/14/19/20/bake-599521_1280.jpg') no-repeat center center; display:none; }
    .cake-tab { padding:20px; border-radius:10px; color:white; font-size:20px; cursor:pointer; text-align:center; width:180px; font-weight:bold; margin:10px; }
    #chocolateTab{background-color:#8B4513;} #blueberryTab{background-color:#1E90FF;} #cherryTab{background-color:#FF69B4;}
    #recipePanel { position:absolute; top:20%; left:5%; padding:20px; border-radius:12px; font-size:18px; display:none; z-index:10; min-width:200px; color:white; }
    #recipePanel h2 { margin-top:0; font-size:22px; text-align:center; }
    #recipePanel ul { list-style:none; padding:0; }
    #recipePanel li { margin:8px 0; font-weight:bold; cursor: pointer; transition: color 0.3s; }
    #recipePanel li.collected { color:lightgreen; cursor: default; text-decoration: line-through;}
    #recipePanel.chocolate { background-color: rgba(139, 69, 19, 0.8); }
    #recipePanel.blueberry { background-color: rgba(30, 144, 255, 0.8); }
    #recipePanel.cherry { background-color: rgba(255, 105, 180, 0.8); }
    
    /* Loading Bar Styles */
    #loading-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50%;
      max-width: 400px;
      background-color: #333;
      border: 2px solid white;
      border-radius: 10px;
      padding: 5px;
      display: none;
      z-index: 9999;
    }
    #loading-bar {
      width: 0%;
      height: 30px;
      background-color: #4CAF50;
      border-radius: 5px;
      text-align: center;
      line-height: 30px;
      color: white;
      transition: width 0.1s linear;
    }
    #loading-text {
      position: absolute;
      width: 100%;
      text-align: center;
      top: -35px;
      color: white;
      font-size: 20px;
      font-weight: bold;
    }

  </style>
</head>
<body>
  <div id="startScreen">
    <h1 style="color:white;">Bake your cake</h1>
    <button onclick="startGame()">Start</button>
  </div>

  <div id="cakeChoices">
    <div id="chocolateTab" class="cake-tab" onclick="chooseCake('chocolate')">Chocolate Cake</div>
    <div id="blueberryTab" class="cake-tab" onclick="chooseCake('blueberry')">Blueberry Cake</div>
    <div id="cherryTab" class="cake-tab" onclick="chooseCake('cherry')">Cherry Cake</div>
  </div>

  <div id="recipePanel"></div>
  
  <div id="loading-container">
    <div id="loading-text">Baking...</div>
    <div id="loading-bar">0%</div>
  </div>

  <a-scene id="scene" physics="gravity:-9.8" style="display:none;">
    
    <a-entity id="player"
              camera
              look-controls
              wasd-controls="acceleration: 150"
              position="0 1.6 5"
              kinematic-body="shape: capsule; radius: 0.4; height: 1.6">
    </a-entity>

    <a-entity light="type:ambient; intensity:0.5"></a-entity>
    <a-entity light="type:directional; intensity:0.8" position="0 2 1"></a-entity>

    <a-plane id="physical-floor" static-body position="0 0 0" rotation="-90 0 0" width="50" height="50" visible="false"></a-plane>

    <!-- Kitchen and Items -->
    <a-entity id="backwall" gltf-model="backwall.glb" static-body="shape: box;"></a-entity>
    <a-entity id="frontwall" gltf-model="frontwall.glb" static-body="shape: box;"></a-entity>
    <a-entity id="rightwall" gltf-model="rightwall.glb" static-body="shape: box;"></a-entity>
    <a-entity id="leftwall" gltf-model="leftwall.glb" static-body="shape: box;"></a-entity>
    <a-entity id="floor" gltf-model="floor.glb"></a-entity>
    <a-entity id="fridge" gltf-model="fridge.glb" static-body="shape: box;"></a-entity>
    <a-entity id="roof" gltf-model="roof.glb" static-body="shape: box;"></a-entity>
    <a-entity id="counterdecor" gltf-model="counterdecor.glb" static-body="shape: box;"></a-entity>
    <a-entity id="counters" gltf-model="counters.glb" static-body="shape: box;"></a-entity>
    <a-entity id="radio" gltf-model="radio.glb" static-body="shape: box;"></a-entity>
    <a-entity id="light" gltf-model="light.glb" static-body="shape: box;"></a-entity>
    <a-entity id="salt" gltf-model="salt.glb" static-body="shape: box;"></a-entity>
    <a-entity id="eggcarton" gltf-model="eggcarton.glb" static-body="shape: box;"></a-entity>
    <a-entity id="mixingbowl" gltf-model="mixingbowl.glb" static-body="shape: cylinder;"></a-entity>
    <a-entity id="cuttingboard" gltf-model="cuttingboard.glb" static-body="shape: box;"></a-entity>
    <a-entity id="shelves" gltf-model="shelves.glb" static-body="shape: box;"></a-entity>
    <a-entity id="knife" gltf-model="knife.glb" static-body="shape: box;"></a-entity>
    <a-entity id="stool" gltf-model="stool.glb" static-body="shape: box;"></a-entity>
    <a-entity id="stove" gltf-model="stove.glb" static-body="shape: box;"></a-entity>
    <a-entity id="vanilla" gltf-model="vanilla.glb" static-body="shape: box;"></a-entity>
    <a-entity id="strawberry" gltf-model="strawberry.glb" static-body="shape: sphere; radius: 0.05;"></a-entity>
    <a-entity id="spatula" gltf-model="spatula.glb" static-body="shape: box;"></a-entity>
    <a-entity id="whisk" gltf-model="whisk.glb" static-body="shape: box;"></a-entity>
    <a-entity id="banana" gltf-model="banana.glb" static-body="shape: box;"></a-entity>

    <!-- Ingredients with the new fade-out component -->
    <a-entity id="flour" gltf-model="flour.glb" class="ingredient" static-body="shape: box;" data-name="flour" fade-out></a-entity>
    <a-entity id="sugar" gltf-model="sugar.glb" class="ingredient" static-body="shape: box;" data-name="sugar" fade-out></a-entity>
    <a-entity id="butter" gltf-model="butter.glb" class="ingredient" static-body="shape: box;" data-name="butter" fade-out></a-entity>
    <a-entity id="milk" gltf-model="milk.glb" class="ingredient" static-body="shape: box;" data-name="milk" fade-out></a-entity>
    <a-entity id="egg" gltf-model="egg.glb" class="ingredient" static-body="shape: sphere; radius: 0.04;" data-name="egg" fade-out></a-entity>
    <a-entity id="blueberry" gltf-model="blueberry.glb" class="ingredient" static-body="shape: sphere; radius: 0.03;" data-name="blueberry" fade-out></a-entity>
    <a-entity id="cherries" gltf-model="cherries.glb" class="ingredient" static-body="shape: sphere; radius: 0.03;" data-name="cherries" fade-out></a-entity>
    <a-entity id="chocolate" gltf-model="chocolate.glb" class="ingredient" static-body="shape: box;" data-name="chocolate" fade-out></a-entity>

    <!-- Final Cake Container -->
    <a-entity id="final-cake-container" position="0 1 -3" visible="false">
        <a-entity id="chocolate-cake-model" gltf-model="#chocolate-cake.glb" visible="false"></a-entity>
        <a-entity id="blueberry-cake-model" gltf-model="#blueberry-cake.glb" visible="false"></a-entity>
        <a-entity id="cherry-cake-model" gltf-model="#cherry-cake.glb" visible="false"></a-entity>
    </a-entity>

    <a-sound id="mainmusic" src="baking cooking jazz.mp3" autoplay="false" loop="true"></a-sound>
  </a-scene>

  <script>
    // --- NEW SCRIPT TO GUARANTEE FADING ANIMATION ---
    AFRAME.registerComponent('fade-out', {
      init: function () {
        this.el.addEventListener('start-fade', () => {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;

          // Animate the opacity of all materials on the model
          mesh.traverse(node => {
            if (node.isMesh && node.material) {
              // Ensure material is transparent
              node.material.transparent = true;
              
              new AFRAME.TWEEN.Tween({ opacity: node.material.opacity })
                .to({ opacity: 0 }, 1500) // 1500ms duration
                .onUpdate(function () {
                  node.material.opacity = this.opacity;
                })
                .start();
            }
          });
          
          setTimeout(() => {
            this.el.setAttribute('visible', 'false');
          }, 1500);
        });
      }
    });

    let currentIngredients = [];
    let collectedIngredients = [];
    let selectedCake = '';

    function startGame(){
      document.getElementById('startScreen').style.display='none';
      document.getElementById('cakeChoices').style.display='flex';
      const music = document.querySelector('#mainmusic');
      if(music && music.components.sound && !music.components.sound.isPlaying){
        music.components.sound.playSound();
      }
    }

    function chooseCake(cakeName){
      selectedCake = cakeName;
      document.getElementById('cakeChoices').style.display='none';
      document.getElementById('scene').style.display='block';

      const recipePanel = document.getElementById('recipePanel');
      recipePanel.style.display='block';
      recipePanel.className = cakeName;

      const baseIngredients = ["flour", "sugar", "butter", "milk", "egg"];
      if(cakeName === 'blueberry'){
        currentIngredients = [...baseIngredients, "blueberry"];
      } else if(cakeName === 'chocolate'){
        currentIngredients = [...baseIngredients, "chocolate"];
      } else if(cakeName === 'cherry'){
        currentIngredients = [...baseIngredients, "cherries"];
      }

      let recipeHTML = `<h2>${cakeName.charAt(0).toUpperCase()+cakeName.slice(1)} Cake</h2><ul>`;
      currentIngredients.forEach(ingredient => {
        recipeHTML += `<li id="recipe-${ingredient}" onclick="collectIngredient('${ingredient}')"><span class="check"></span> ${ingredient}</li>`;
      });
      recipeHTML += `</ul>`;
      recipePanel.innerHTML = recipeHTML;
    }
    
    function collectIngredient(ingredientName) {
      if (collectedIngredients.includes(ingredientName)) {
        return; 
      }

      if (currentIngredients.includes(ingredientName)) {
        collectedIngredients.push(ingredientName);
        
        const li = document.getElementById(`recipe-${ingredientName}`);
        if (li) {
          li.classList.add('collected');
          li.querySelector('.check').textContent = 'âœ… ';
        }
        
        // Find the 3D model in the scene and tell it to start fading
        const ingredientEntity = document.querySelector(`.ingredient[data-name="${ingredientName}"]`);
        if (ingredientEntity) {
          ingredientEntity.emit('start-fade'); // FIXED: Send a signal to the new component
        }
        
        checkCompletion();
      }
    }

    function checkCompletion() {
      if (collectedIngredients.length === currentIngredients.length) {
        startBakingSequence();
      }
    }

    function startBakingSequence() {
      const loadingContainer = document.getElementById('loading-container');
      const loadingBar = document.getElementById('loading-bar');
      loadingContainer.style.display = 'block';

      let progress = 0;
      const interval = setInterval(() => {
        progress += 1;
        loadingBar.style.width = progress + '%';
        loadingBar.textContent = progress + '%';
        if (progress >= 100) {
          clearInterval(interval);
          loadingContainer.style.display = 'none';
          showFinalCake();
        }
      }, 50);
    }

    function showFinalCake() {
      document.getElementById('mixingbowl').setAttribute('visible', 'false');
      const finalCake = document.getElementById('final-cake-container');
      const cakeModel = document.getElementById(`${selectedCake}-cake-model`);
      cakeModel.setAttribute('visible', 'true');
      finalCake.setAttribute('visible', 'true');
      finalCake.setAttribute('animation', {
        property: 'scale',
        from: '0.01 0.01 0.01',
        to: '1 1 1',
        dur: 1500,
        easing: 'easeOutElastic'
      });
    }
  </script>
</body>
</html>```
